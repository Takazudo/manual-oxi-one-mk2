name: Production Deploy

# Runs on pushes to main branch
# Includes quality checks, build, and production deployment
on:
  push:
    branches:
      - main

# Prevent concurrent production deployments
concurrency:
  group: production-deploy
  cancel-in-progress: false

# Grant necessary permissions
permissions:
  contents: read
  deployments: write
  statuses: write

jobs:
  # Step 1: Quality checks
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: false

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript type checking
        run: pnpm run typecheck

      - name: Run ESLint
        run: pnpm run lint

      - name: Check Prettier formatting
        run: pnpm run format

  # Step 2: Build for production
  build:
    name: Build Production Site
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: false

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: nextjs-cache-v1-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'tsconfig.json') }}
          restore-keys: nextjs-cache-v1-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js site for production
        run: pnpm run build
        env:
          NODE_ENV: production
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Monitor Build Performance
        run: |
          echo "üìä Build Performance Metrics"
          echo "================================"

          # Calculate sizes (using portable commands)
          OUT_SIZE=$(du -sh out 2>/dev/null | cut -f1 || echo "Unknown")
          MANUAL_SIZE=$(du -sh public/manual 2>/dev/null | cut -f1 || echo "Unknown")

          echo "üìÅ Output directory: $OUT_SIZE"
          echo "üìö Manual images: $MANUAL_SIZE"
          echo "================================"

          # Count files for metrics
          if [ -d "out" ]; then
            PAGE_COUNT=$(find out -name "*.html" | wc -l)
            echo "üìÑ HTML pages: $PAGE_COUNT"
          fi

          echo "================================"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: nextjs-build-production
          path: out/
          include-hidden-files: true
          retention-days: 1

  # Step 3: Deploy to production
  deploy:
    name: Deploy to Production
    needs: [quality, build]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: false

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: nextjs-build-production
          path: out

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify Production
        id: deploy
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          echo "üöÄ Deploying to Netlify production..."

          # Copy build output to temp directory outside git repo
          TEMP_DIR=$(mktemp -d)
          echo "üìÇ Copying build output to temporary directory: $TEMP_DIR"
          cp -r out/* "$TEMP_DIR/"

          # Copy netlify.toml but remove build section
          cp netlify.toml "$TEMP_DIR/"
          echo "   - Copied netlify.toml"

          # Remove [build] section since we're deploying pre-built files
          sed -i.bak '/^\[build\]/,/^$/d' "$TEMP_DIR/netlify.toml" || sed -i '' '/^\[build\]/,/^$/d' "$TEMP_DIR/netlify.toml"
          echo "   - Removed [build] section"

          # Deploy from the temporary directory
          cd "$TEMP_DIR"

          DEPLOY_OUTPUT=$(netlify deploy \
            --dir=. \
            --site=$NETLIFY_SITE_ID \
            --auth=$NETLIFY_AUTH_TOKEN \
            --prod \
            --message="Production deploy: ${{ github.sha }}")

          echo "$DEPLOY_OUTPUT"

          DEPLOY_URL="https://manual-oxi-one-mk2.netlify.app"
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT

          echo "‚úÖ Deployed to production: $DEPLOY_URL"

          # Clean up temp directory
          rm -rf "$TEMP_DIR"

      - name: Create deployment record
        uses: actions/github-script@v8
        with:
          script: |
            // Create a deployment record
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: 'Production deployment to Netlify',
              production_environment: true,
              auto_merge: false,
              required_contexts: []
            });

            // Update deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.DEPLOY_URL }}',
              description: 'Deployment successful'
            });

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const emoji = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'success' : 'failure';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              target_url: '${{ steps.deploy.outputs.DEPLOY_URL }}',
              description: success ? 'Production deployment successful' : 'Production deployment failed',
              context: 'netlify/production'
            });
