name: Deploy preview/* to Netlify Preview

# Triggers on pushes to any preview/* branch
# Builds Next.js and deploys to preview site
on:
  push:
    branches:
      - 'preview/*'

# Prevent concurrent deployments per branch
concurrency:
  group: preview-deploy-${{ github.ref }}
  cancel-in-progress: true

# Grant necessary permissions
permissions:
  contents: write # Allows git operations
  pull-requests: write # Allows creating PR comments for deployment URLs
  deployments: write
  statuses: write

jobs:
  deploy:
    name: Build and Deploy to Netlify Preview
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          lfs: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run code quality checks
        run: |
          echo "ğŸ” Running code quality checks..."
          pnpm run typecheck
          pnpm run lint
          pnpm run format
          echo "âœ… Code quality checks passed"

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: nextjs-cache-v1-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'tsconfig.json') }}
          restore-keys: nextjs-cache-v1-${{ runner.os }}-

      - name: Build Next.js
        run: pnpm build
        env:
          NODE_ENV: production
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Verify build output
        run: |
          echo "ğŸ“¦ Build Output Verification"
          echo "============================"

          if [ ! -d "out" ]; then
            echo "âŒ Error: out/ directory not found"
            exit 1
          fi

          # Count output files
          HTML_COUNT=$(find out -name "*.html" | wc -l)
          echo "ğŸ“„ HTML files: $HTML_COUNT"

          if [ -d "out/_next" ]; then
            echo "âœ… Next.js static assets found"
          else
            echo "âŒ Error: _next/ directory not found"
            exit 1
          fi

          echo "============================"
          echo "âœ… Build output verified"

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify Preview
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Netlify preview site..."

          # Copy build output to temp directory outside git repo to avoid monorepo detection
          TEMP_DIR=$(mktemp -d)
          echo "ğŸ“‚ Copying build output to temporary directory: $TEMP_DIR"
          cp -r out/* "$TEMP_DIR/"

          # Copy netlify.toml but remove build section for preview
          cp netlify.toml "$TEMP_DIR/"
          echo "   - Copied netlify.toml"

          # Remove [build] section since we're deploying pre-built files
          sed -i.bak '/^\[build\]/,/^$/d' "$TEMP_DIR/netlify.toml" || sed -i '' '/^\[build\]/,/^$/d' "$TEMP_DIR/netlify.toml"
          echo "   - Removed [build] section"

          # Deploy from the temporary directory
          cd "$TEMP_DIR"

          DEPLOY_OUTPUT=$(netlify deploy \
            --dir=. \
            --site=${{ secrets.NETLIFY_SITE_ID }} \
            --auth=${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --alias=preview \
            --context deploy-preview \
            --message="Deploy preview branch - ${{ github.sha }}")

          echo "$DEPLOY_OUTPUT"

          # Extract and save the deploy URL
          DEPLOY_URL="https://preview--manual-oxi-one-mk2.netlify.app"
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT

          echo "âœ… Deployed to $DEPLOY_URL"

          # Clean up temp directory
          rm -rf "$TEMP_DIR"

      - name: Create deployment record
        uses: actions/github-script@v8
        with:
          script: |
            // Create a deployment record
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'preview',
              description: 'Next.js preview deployment to Netlify',
              production_environment: false,
              auto_merge: false,
              required_contexts: []
            });

            // Update deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.DEPLOY_URL }}',
              description: 'Preview deployment successful'
            });

      - name: Comment deployment URL on PR
        uses: actions/github-script@v8
        with:
          script: |
            // Find PR for this branch
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length > 0) {
              // Comment on the PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                body: 'âœ… **Preview Deployed**\n\nğŸ”— **URL**: ${{ steps.deploy.outputs.DEPLOY_URL }}\n\nğŸ“¦ **Branch**: `${{ github.ref_name }}`\nğŸ—ï¸ **Build**: Next.js static export\nâ±ï¸ **Commit**: `${{ github.sha }}`'
              });
              console.log(`Posted deployment URL to PR #${prs[0].number}`);
            } else {
              console.log('No open PR found for this branch, skipping comment');
            }

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const emoji = success ? 'âœ…' : 'âŒ';
            const status = success ? 'success' : 'failure';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              target_url: '${{ steps.deploy.outputs.DEPLOY_URL }}',
              description: success ? 'Preview deployment successful' : 'Preview deployment failed',
              context: 'netlify/preview'
            });
